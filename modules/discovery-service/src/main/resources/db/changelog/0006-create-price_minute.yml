databaseChangeLog:
  - changeSet:
      id: 0006-create-price_minute
      author: cs
      changes:
        - createTable:
            tableName: price_minute
            remarks: "Минутные цены per-venue (для графика: линии площадок)."
            columns:
              - column:
                  name: asset
                  type: text
                  remarks: "FK → instruments.asset."
                  constraints:
                    nullable: false
                    references: instruments(asset)
                    foreignKeyName: fk_price_minute_instruments
              - column:
                  name: venue
                  type: text
                  remarks: "FK → venues. Какая площадка."
                  constraints:
                    nullable: false
                    references: venues(venue)
                    foreignKeyName: fk_price_minute_venues
              - column:
                  name: kind
                  type: text
                  remarks: "Тип рынка: SPOT | PERP | FUTURES | DEX."
                  constraints:
                    nullable: false
              - column:
                  name: ts_minute
                  type: timestamp with time zone
                  remarks: "Отметка минуты (UTC)."
                  constraints:
                    nullable: false
              - column:
                  name: mid
                  type: numeric(38,18)
                  remarks: "Средняя цена (mid) за минуту для данного рынка."
                  constraints:
                    nullable: false

        - addPrimaryKey:
            tableName: price_minute
            columnNames: asset, venue, kind, ts_minute
            constraintName: pk_price_minute

        # CHECK (kind in (...)) через SQL
        - sql:
            dbms: postgresql
            splitStatements: false
            stripComments: true
            sql: |
              ALTER TABLE price_minute
              ADD CONSTRAINT ck_price_minute_kind
              CHECK (kind IN ('SPOT','PERP','FUTURES','DEX'));

      rollback:
        - sql: |
            ALTER TABLE price_minute DROP CONSTRAINT IF EXISTS ck_price_minute_kind;
