databaseChangeLog:
  - changeSet:
      id: 0008-create-alerts
      author: cs
      changes:
        - createTable:
            tableName: alerts
            remarks: "События алертов на раскор: OPEN/CLOSE с параметрами."
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  remarks: "Идентификатор события алерта. PK."
                  constraints:
                    primaryKey: true
                    primaryKeyName: pk_alerts
              - column:
                  name: ts
                  type: timestamp with time zone
                  remarks: "Время генерации события (UTC)."
                  constraints:
                    nullable: false
              - column:
                  name: asset
                  type: text
                  remarks: "FK → instruments.asset (по какому инструменту)."
                  constraints:
                    nullable: false
                    references: instruments(asset)
                    foreignKeyName: fk_alerts_instruments
              - column:
                  name: market_id
                  type: bigint
                  remarks: "FK → markets.market_id (на каком рынке обнаружено отклонение)."
                  constraints:
                    nullable: false
              - column:
                  name: dev_pct
                  type: numeric(12,6)
                  remarks: "Отклонение dev = (price - fair - bias)/fair, в долях (0.03 = 3%)."
                  constraints:
                    nullable: false
              - column:
                  name: fair
                  type: numeric(38,18)
                  remarks: "Справедливая цена в момент события."
                  constraints:
                    nullable: false
              - column:
                  name: price
                  type: numeric(38,18)
                  remarks: "Цена рынка в момент события."
                  constraints:
                    nullable: false
              - column:
                  name: bias
                  type: numeric(38,18)
                  remarks: "Текущий bias рынка в момент события."
                  constraints:
                    nullable: false
              - column:
                  name: threshold_pct
                  type: numeric(12,6)
                  remarks: "Порог срабатывания (в долях), записан для воспроизводимости."
                  constraints:
                    nullable: false
              - column:
                  name: state
                  type: text
                  remarks: "Состояние алерта: OPEN — открытие, CLOSE — закрытие."
                  constraints:
                    nullable: false

        # FK на markets.market_id (отдельным шагом — так надёжнее)
        - addForeignKeyConstraint:
            baseTableName: alerts
            baseColumnNames: market_id
            referencedTableName: markets
            referencedColumnNames: market_id
            constraintName: fk_alerts_markets
            onDelete: RESTRICT
            onUpdate: RESTRICT

        # CHECK (state in (...)) через SQL
        - sql:
            dbms: postgresql
            splitStatements: false
            stripComments: true
            sql: |
              ALTER TABLE alerts
              ADD CONSTRAINT ck_alerts_state
              CHECK (state IN ('OPEN','CLOSE'));

      rollback:
        - sql: |
            ALTER TABLE alerts DROP CONSTRAINT IF EXISTS ck_alerts_state;
        - dropForeignKeyConstraint:
            baseTableName: alerts
            constraintName: fk_alerts_markets
